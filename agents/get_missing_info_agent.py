import re
import json
from langchain.agents import initialize_agent, AgentType  # type: ignore
from langchain.tools import tool  # type: ignore
from llm import llm  # type: ignore

# Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø·Ø§Ø±Ø¦
emergency_questions = {
  "CIVIL": [
    "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù‚ÙŠÙ‚",
    "Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ù…ØµØ§Ø¨ÙˆÙ† Ø£Ùˆ Ù…ÙÙ‚ÙˆØ¯ÙˆÙ† ",
    "Ù‡Ù„ Ø§Ù„Ø·Ø±Ù‚ Ù…Ù‚Ø·ÙˆØ¹Ø© ",
    "Ù‡Ù„ ØªØ­ØªØ§Ø¬ÙˆÙ† Ø¥Ù„Ù‰ Ø¥Ù†Ù‚Ø§Ø° ÙÙˆØ±ÙŠ ",
    "Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ",
    "Ù…Ø¯Ù‰ ØªØ£Ø«ÙŠØ±Ù‡Ø§ (Ù…Ù†Ø²Ù„ ÙˆØ§Ø­Ø¯ / Ø­ÙŠ ÙƒØ§Ù…Ù„ØŒ ÙˆÙ„Ø¯ÙŠÙ†Ø§ Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)",
    "Ù…Ù†Ø° Ù…ØªÙ‰ Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŸ ",
    "Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø®Ø·Ø± Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ø±Ø©ØŸ ",
    "ÙˆØµÙ Ø§Ù„Ø´Ø®Øµ (Ø§Ù„Ø·ÙÙ„ØŒ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯...) ",
    "Ù…ÙˆÙ‚Ø¹ Ø¢Ø®Ø± Ù…Ø´Ø§Ù‡Ø¯Ø© ",
    "Ù‡Ù„ Ù‡Ùˆ ÙÙŠ Ø®Ø·Ø± Ù…Ø¨Ø§Ø´Ø±ØŸ ",
    "Ù…Ø¯Ø© Ø§Ù„ØºÙŠØ§Ø¨ Ø£Ùˆ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„ ",
    "Ù‡Ù„ Ø£Ø¸Ù‡Ø± Ø³Ù„ÙˆÙƒÙ‹Ø§ ØºØ±ÙŠØ¨Ù‹Ø§ Ø£Ùˆ Ø®Ø·Ø±Ù‹Ø§ØŸ ",
    "ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¥Ù† ÙˆÙØ¬Ø¯Øª "
  ],
  "FIRE": [
    "Ù†ÙˆØ¹ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø­ØªØ±Ù‚ (Ù…Ù†Ø²Ù„ØŒ Ø³ÙŠØ§Ø±Ø©ØŒ Ù…Ø³ØªÙˆØ¯Ø¹...) ",
    "Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ø£Ø´Ø®Ø§Øµ Ø¹Ø§Ù„Ù‚ÙˆÙ† ",
    "Ù…Ø¯Ù‰ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø­Ø±ÙŠÙ‚ ",
    "ÙˆØ¬ÙˆØ¯ Ù…ÙˆØ§Ø¯ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ù†ÙØ¬Ø§Ø± ",
    "Ù…ØµØ¯Ø± Ø§Ù„Ø§Ù†ÙØ¬Ø§Ø± Ø£Ùˆ Ø§Ù„ØªØ³Ø±Ø¨ ",
    "Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ù…ØµØ§Ø¨ÙˆÙ† ",
    "Ù‡Ù„ ØªÙ… Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ù…ÙƒØ§Ù† ",
    "Ù…Ø¯Ù‰ Ø§Ù„Ø¶Ø±Ø± Ø§Ù„Ù…Ø§Ø¯ÙŠ Ø§Ù„Ø¸Ø§Ù‡Ø± "
  ],
  "MEDICAL": [
    "Ø¹Ù…Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ ",
    "Ø§Ù„ÙˆØ¹ÙŠ: ÙˆØ§Ø¹ÙŠ / ÙØ§Ù‚Ø¯ ÙˆØ¹ÙŠ ",
    "Ù‡Ù„ ÙŠØªÙ†ÙØ³ Ø§Ù„Ù…Ø±ÙŠØ¶ ",
    "Ù‡Ù„ ØªÙ„Ù‚Ù‰ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø£ÙŠ Ø¥Ø³Ø¹Ø§Ù Ø£ÙˆÙ„ÙŠ ",
    "Ù…Ø¯Ø© Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„Ø© "
  ],
  "POLICE": [
    "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ† ",
    "Ù‡Ù„ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù…ØºÙ„Ù‚ ",
    "Ù…ÙˆÙ‚Ø¹ Ø¯Ù‚ÙŠÙ‚ ",
    "Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª ",
    "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ",
    "Ù†ÙˆØ¹ Ø§Ù„Ø³Ù„Ø§Ø­ Ø¥Ù† ÙˆÙØ¬Ø¯ ",
    "Ù‡Ù„ Ù‡Ù†Ø§Ùƒ Ù…ØµØ§Ø¨ÙˆÙ† ",
    "ÙˆØµÙ Ø§Ù„Ø´Ø®Øµ Ø£Ùˆ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…ØªÙˆØ±Ø·ÙŠÙ† "
  ]
}

# =============================================================>


# ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯Ø§Ù„Ø© tool Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
@tool
def get_missing_info(input_text: str) -> str:
    """
    ÙŠØ­Ù„Ù„ Ø§Ù„Ø¨Ù„Ø§Øº ÙˆÙŠØ³ØªÙ†ØªØ¬ Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ© (Ù…Ø«Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ†ØŒ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ ØµÙˆØ±ØŒ ...).
    ÙŠØ±Ø¬Ø¹ Ù†ØµÙ‹Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¨Ù„ØºØ© Ù…Ù‡Ø°Ø¨Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø·Ø§Ø±Ø¦ ÙÙ‚Ø·.
    """
    
    import re, json

    user_input_match = re.search(r"Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\s*(.*)", input_text)
    emergency_type_match = re.search(r"Ù†ÙˆØ¹ Ø§Ù„Ø·Ø§Ø±Ø¦:\s*(.*)", input_text)
    emergency_subtype_match = re.search(r"Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:\s*(.*)", input_text)

    user_input = user_input_match.group(1).strip() if user_input_match else ""
    emergency_type = emergency_type_match.group(1).strip() if emergency_type_match else "UNKNOWN"
    emergency_subtype = emergency_subtype_match.group(1).strip() if emergency_subtype_match else ""

    questions = emergency_questions.get(emergency_type)
    if not questions:
        return f"âŒ Ù†ÙˆØ¹ Ø§Ù„Ø·Ø§Ø±Ø¦ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: {emergency_type}"

    questions_prompt = "\n".join([f"- {q}" for q in questions])
    prompt = f"""
Ù‡Ø°Ø§ Ø¨Ù„Ø§Øº Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_input}

â—ï¸Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº: {emergency_type}
ðŸ§© Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: {emergency_subtype}

Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù†Ø§Ù‚ØµØ© ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ØŸ  
ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø£Ù…Ø«Ù„Ø© Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªÙƒÙˆÙ† Ù†Ø§Ù‚ØµØ©:

{questions_prompt}

âœ… Ø£Ø¬Ø¨ ÙÙ‚Ø· Ø¨Ù‚Ø§Ø¦Ù…Ø© JSON ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù†Ø§Ù‚ØµØ© Ù…Ù† Ø§Ù„Ø¨Ù„Ø§Øº.
[
"ØŸ",
"ØŸ",
...
]

â›”ï¸ Ù„Ø§ ØªÙƒØªØ¨ Ø£ÙŠ Ø´Ø±Ø­ Ø£Ùˆ Ø¬Ù…Ù„Ø© Ø®Ø§Ø±Ø¬ JSON.
"""
    response = llm.invoke(prompt)
    try:
        match = re.search(r"\[.*?\]", response.content, re.DOTALL)
        missing_questions = json.loads(match.group(0)) if match else []
        if missing_questions:
            formatted_list = "\n".join([f"- {q}" for q in missing_questions])
            return f"âœ… Ø´ÙƒØ±Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù„Ø§Øº. Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©ØŒ ÙŠÙØ±Ø¬Ù‰ ØªÙˆØ¶ÙŠØ­ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª:\n{formatted_list}"
        else:
            return "âœ… Ø§Ù„Ø¨Ù„Ø§Øº ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§ÙÙŠØ© ÙƒØ¨Ø¯Ø§ÙŠØ©ØŒ Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ."
    except Exception as e:
        print("[âŒ parsing error]:", e)
        return "ØªØ¹Ø°Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø§Ù‚ØµØ©. ÙŠÙØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©."


# =============================================================>

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„
get_missing_info_agent = initialize_agent(
    tools=[get_missing_info],
    llm=llm,
    agent=AgentType.OPENAI_FUNCTIONS,
    verbose=False,
)
